{"ast":null,"code":"import _slicedToArray from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectSpread from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _assertThisInitialized from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";import _inherits from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/kian/HAKEE/annotator_app/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from\"react\";import\"./DescriptionPane.css\";import{DragDropContext,Draggable,Droppable}from\"react-beautiful-dnd\";import StepDescription from\"./StepDescription\";import{sendDataToServer}from\"../apiCalls\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var DescriptionPane=/*#__PURE__*/function(_React$Component){_inherits(DescriptionPane,_React$Component);var _super=_createSuper(DescriptionPane);function DescriptionPane(props){var _this;_classCallCheck(this,DescriptionPane);_this=_super.call(this,props);_this.counter=0;_this.sessionTime=\"\";_this.state={descriptions:[{key:0,mode:\"writing\",level:1,selected:true,text:\"\"}]};_this.counter+=1;_this.setModeByKey=_this.setModeByKey.bind(_assertThisInitialized(_this));_this.getMode=_this.getMode.bind(_assertThisInitialized(_this));_this.addStepAfter=_this.addStepAfter.bind(_assertThisInitialized(_this));_this.removeWritingStep=_this.removeWritingStep.bind(_assertThisInitialized(_this));_this.getSelected=_this.getSelected.bind(_assertThisInitialized(_this));_this.getWritingStep=_this.getWritingStep.bind(_assertThisInitialized(_this));_this.deselectAll=_this.deselectAll.bind(_assertThisInitialized(_this));_this.getIndex=_this.getIndex.bind(_assertThisInitialized(_this));_this.getWritingIndex=_this.getWritingIndex.bind(_assertThisInitialized(_this));_this.removeItem=_this.removeItem.bind(_assertThisInitialized(_this));_this.updateDescendents=_this.updateDescendents.bind(_assertThisInitialized(_this));_this.getDescendents=_this.getDescendents.bind(_assertThisInitialized(_this));_this.deleteItems=_this.deleteItems.bind(_assertThisInitialized(_this));_this.getPrevSibling=_this.getPrevSibling.bind(_assertThisInitialized(_this));_this.groupDescriptions=_this.groupDescriptions.bind(_assertThisInitialized(_this));_this.getSessionTime=_this.getSessionTime.bind(_assertThisInitialized(_this));_this.handleSingleClick=_this.handleSingleClick.bind(_assertThisInitialized(_this));_this.handleBlur=_this.handleBlur.bind(_assertThisInitialized(_this));_this.handleKeyAction=_this.handleKeyAction.bind(_assertThisInitialized(_this));_this.handleDragEnd=_this.handleDragEnd.bind(_assertThisInitialized(_this));_this.handleWindowResize=_this.handleWindowResize.bind(_assertThisInitialized(_this));return _this;}_createClass(DescriptionPane,[{key:\"render\",value:function render(){var _this2=this;if(this.counter===2){this.sessionTime=this.getSessionTime();}var descriptionListG=this.groupDescriptions(_toConsumableArray(this.state.descriptions));var stepComponentsList=descriptionListG.map(function(stepList,index){return/*#__PURE__*/_jsx(Draggable,{draggableId:index.toString(),index:index,children:function children(provided){return/*#__PURE__*/_jsx(\"div\",_objectSpread(_objectSpread(_objectSpread({id:index.toString(),className:\"step-div\"},provided.draggableProps),provided.dragHandleProps),{},{ref:provided.innerRef,children:stepList.map(function(item,index){return/*#__PURE__*/_jsx(StepDescription,{id:item.key.toString(),onSingleClick:_this2.handleSingleClick,onDoubleClick:_this2.handleDoubleClick,onBlur:_this2.handleBlur,onKeyPress:_this2.handleKeyAction,item:item},item.key.toString());})}),index.toString());}},index.toString());});return/*#__PURE__*/_jsx(DragDropContext,{onDragEnd:this.handleDragEnd,children:/*#__PURE__*/_jsx(Droppable,{droppableId:\"description-pane-droppable\",children:function children(provided){return/*#__PURE__*/_jsxs(\"div\",_objectSpread(_objectSpread({id:\"description-pane-container\",ref:provided.innerRef},provided.droppableProps),{},{children:[stepComponentsList,provided.placeholder]}));}})});}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(prevProps.videoID!==this.props.videoID){this.setState({descriptions:[{key:0,mode:\"writing\",level:1,selected:true,text:\"\"}]});}}},{key:\"componentDidMount\",value:function componentDidMount(){window.addEventListener(\"resize\",this.handleWindowResize);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){window.removeEventListener(\"resize\",this.handleWindowResize);}},{key:\"handleWindowResize\",value:function handleWindowResize(){// const windowWidth = window.innerWidth;\n// const windowHeight = window.innerHeight;\n// if (windowWidth < 1600) {\n//     let paneContainer = document.getElementById(\"description-pane-container\");\n// \tpaneContainer.style.width = 490;\n// } else {\n// \tlet paneContainer = document.getElementById(\"description-pane-container\");\n// \tpaneContainer.style.width = 550;\n// }\n// console.log(\"width: \", windowWidth);\n// console.log(\"height: \", windowHeight);\n}},{key:\"getSessionTime\",value:function getSessionTime(){var d=new Date();var sessionTime=\"\".concat(d.getFullYear(),\"-\").concat(d.getMonth()+1,\"-\").concat(d.getDate(),\"-\").concat(d.getHours(),\"-\").concat(d.getMinutes(),\"-\").concat(d.getSeconds());return sessionTime;}},{key:\"groupDescriptions\",value:function groupDescriptions(descriptions){var descriptionListG=[];var stepDescriptionList=[];for(var i=0;i<descriptions.length;i++){// new step\nif(descriptions[i].level===1){if(stepDescriptionList.length){descriptionListG.push(stepDescriptionList);}stepDescriptionList=[descriptions[i]];}else{// descendents\nstepDescriptionList.push(descriptions[i]);}if(i===descriptions.length-1){if(stepDescriptionList.length){descriptionListG.push(stepDescriptionList);}}}return descriptionListG;}},{key:\"handleDragEnd\",value:function handleDragEnd(result){if(result.destination==null)return;if(result.destination.index===result.source.index)return;var items=_toConsumableArray(this.state.descriptions);// step-set level index\nvar sourceStepIndex=result.source.index;var destinationStepIndex=result.destination.index;var steps=this.groupDescriptions(items);var destinationOffset=destinationStepIndex>sourceStepIndex?1:0;var sourceOffset=destinationStepIndex>sourceStepIndex?0:1;// move a copy of source step into the new location\nsteps.splice(destinationStepIndex+destinationOffset,0,steps[sourceStepIndex]);// remove the old copy of source step\nsteps.splice(sourceStepIndex+sourceOffset,1);sendDataToServer(items,this.sessionTime,this.props.videoID,this.props.user);this.setState({descriptions:steps.flat()});}},{key:\"handleSingleClick\",value:function handleSingleClick(key,txt){var items=_toConsumableArray(this.state.descriptions);if(txt!==\"\"){var index=this.getIndex(items,key,0);var oldWritingIndex=this.getWritingIndex(items);if(oldWritingIndex>=0){items[oldWritingIndex].mode=\"not_writing\";}items[index].mode=\"writing\";items=this.deselectAll(items);items[index].selected=true;this.setState({descriptions:items});}}},{key:\"handleBlur\",value:function handleBlur(key,txt){var items=_toConsumableArray(this.state.descriptions);if(txt!==\"\"){var index=this.getIndex(items,key,0);items[index].mode=\"not_writing\";items[index].text=txt;}else if(txt===\"\"&&items.length>1){items=this.removeWritingStep(items);}//sendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\nthis.setState({descriptions:items});}},{key:\"handleKeyAction\",value:function handleKeyAction(key,txt,event){var items=_toConsumableArray(this.state.descriptions);// del --> delete step\nif(event.which===46||event.type==='click'&&txt==='close_btn'){var currentStepIndex=null;if(key===null){// delete (window listener)\ncurrentStepIndex=this.getSelected(items);}else{// delete (<input> listener)\ncurrentStepIndex=this.getIndex(items,key,0);}if((items[currentStepIndex].selected||event.type==='click'&&txt==='close_btn')&&items.length>=2){// select the previous/next step\nitems=this.deselectAll(items);var descIndexList=this.getDescendents(items,currentStepIndex);if(currentStepIndex===0){items[currentStepIndex+descIndexList.length].selected=true;}else{var prevSiblingIndex=this.getPrevSibling(items,currentStepIndex);var offset=1;if(!(prevSiblingIndex==null)){var prevStepDescIndexList=this.getDescendents(items,prevSiblingIndex);offset=prevStepDescIndexList.length;}items[currentStepIndex-offset].selected=true;}// do not delete everything\nif(descIndexList.length<items.length){items=this.deleteItems(items,descIndexList);sendDataToServer(items,this.sessionTime,this.props.videoID,this.props.user);this.setState({descriptions:items});}}}// Enter --> nex step (writing)\nelse if(event.which===13&&txt!==\"\"){var currentStepMode=this.getMode(items,key,0);var curretnStepIndex=this.getIndex(items,key,0);var newStepIndex=curretnStepIndex;if(currentStepMode===\"writing\"||currentStepMode===\"not_writing\"&&items[curretnStepIndex].selected){// change the current step to non-writing and add one writing step after it\nitems[curretnStepIndex].mode=\"not_writing\";items[curretnStepIndex].text=txt;// select the current step\nitems=this.deselectAll(items);var _this$addStepAfter=this.addStepAfter(items,key,\"writing\",null);var _this$addStepAfter2=_slicedToArray(_this$addStepAfter,2);items=_this$addStepAfter2[0];newStepIndex=_this$addStepAfter2[1];items[newStepIndex].selected=true;items[newStepIndex].mode=\"writing\";sendDataToServer(items,this.sessionTime,this.props.videoID,this.props.user);this.setState({descriptions:items});}}// Tab or Shift + Tab\nelse if(event.which===9||event.type===\"click\"){event.preventDefault();// perform indention if it is writing\nvar _currentStepIndex=this.getIndex(items,key,0);if(_currentStepIndex>0){var _descIndexList=this.getDescendents(items,_currentStepIndex);// only tab\nif(!event.shiftKey||txt===\"indent_btn\"){if((items[_currentStepIndex].mode===\"writing\"||txt===\"indent_btn\")&&items.length>1){if(items[_currentStepIndex-1].level>=items[_currentStepIndex].level&&items[_currentStepIndex].level<=2){items[_currentStepIndex].level+=1;items=this.updateDescendents(items,_descIndexList,\"level_increase\");sendDataToServer(items,this.sessionTime,this.props.videoID,this.props.user);this.setState({descriptions:items});}}}if(event.shiftKey||txt===\"outdent_btn\"){// shift + tab\nif(items[_currentStepIndex].level>=2){items[_currentStepIndex].level-=1;items=this.updateDescendents(items,_descIndexList,\"level_decrease\");sendDataToServer(items,this.sessionTime,this.props.videoID,this.props.user);this.setState({descriptions:items});}}}}// down\nelse if(event.which===40){items=_toConsumableArray(this.state.descriptions);var oldIndex=this.getIndex(items,key,0);// can't go down\nif(oldIndex===items.length-1){this.setState({descriptions:items});return;}// update the selected item\nif(txt!==\"\"){// keep the old item\nitems[oldIndex].text=txt;items[oldIndex].selected=false;items[oldIndex].mode=\"not_writing\";// select the new item\nitems[oldIndex+1].selected=true;items[oldIndex+1].mode=\"writing\";}else{// must be removed\nitems=this.removeItem(items,oldIndex);// select the new item\nitems[oldIndex].selected=true;items[oldIndex].mode=\"writing\";}this.setState({descriptions:items});}// up\nelse if(event.which===38){items=_toConsumableArray(this.state.descriptions);var _oldIndex=this.getIndex(items,key,0);// can't go up\nif(_oldIndex===0){this.setState({descriptions:items});return;}// update the selected item\nif(txt!==\"\"){// keep the old item\nitems[_oldIndex].text=txt;items[_oldIndex].selected=false;items[_oldIndex].mode=\"not_writing\";// select the new item\nitems[_oldIndex-1].selected=true;items[_oldIndex-1].mode=\"writing\";}else{// must be removed\nitems=this.removeItem(items,_oldIndex);// select the new item\nitems[_oldIndex-1].selected=true;items[_oldIndex-1].mode=\"writing\";}this.setState({descriptions:items});}else if(event.which===40||event.which===38){items=_toConsumableArray(this.state.descriptions);var _oldIndex2=this.getIndex(items,key,0);if(_oldIndex2===items.length-1&&event.which===40)return;if(_oldIndex2===0&&event.which===38)return;// take care of the old selected item\nvar oldItemIsRemoved=false;if(txt===\"\"){if(items.length>1){// should be  deleted\nitems=this.removeItem(items,_oldIndex2);oldItemIsRemoved=true;}else{return;// length = 0 --> you cannot go to another item\n}}else{items[_oldIndex2].text=txt;items[_oldIndex2].selected=false;items[_oldIndex2].mode=\"not_writing\";}// selected the new item (already know that items.length > 1)\nvar newIndex=_oldIndex2;if(event.which===40){// down\nif(!oldItemIsRemoved&&_oldIndex2<items.length-1){newIndex=_oldIndex2+1;}}else{// up\nif(_oldIndex2>0)newIndex=_oldIndex2-1;}items=this.deselectAll(items);items[newIndex].selected=true;items[newIndex].mode=\"writing\";this.setState({descriptions:items});}}// TODO:\n// 4) add guiddance (key bindings, ...)\n// 5) record timestamp\n// 6) record video control events (number of times, and types (jump to the future/past))\n},{key:\"getIndex\",value:function getIndex(stateItems,descriptionKey,offset){var items=_toConsumableArray(stateItems);var itemIndex=items.map(function(item){return item.key;}).indexOf(parseInt(descriptionKey));if(itemIndex>=0){return itemIndex+offset;}return-1;}},{key:\"getWritingIndex\",value:function getWritingIndex(items){for(var i=0;i<items.length;i++){if(items[i].mode===\"writing\"){return i;}}return-1;}},{key:\"setModeByKey\",value:function setModeByKey(stateItems,descriptionKey,mode){var items=_toConsumableArray(stateItems);var itemIndex=items.map(function(item){return item.key;}).indexOf(parseInt(descriptionKey));if(itemIndex>=0){items[itemIndex].mode=mode;}else{console.log(\"step description does not exist\");}return items;}},{key:\"getMode\",value:function getMode(stateItems,descriptionKey,offset){var items=_toConsumableArray(stateItems);var itemIndex=items.map(function(item){return item.key;}).indexOf(parseInt(descriptionKey));if(items[itemIndex+offset]!==undefined){return items[itemIndex+offset].mode;}return undefined;}},{key:\"getSelected\",value:function getSelected(items){for(var i=0;i<items.length;i++){if(items[i].selected){return i;}}return-1;}},{key:\"getWritingStep\",value:function getWritingStep(items){for(var i=0;i<items.length;i++){if(items[i].mode===\"writing\"){return i;}}return-1;}},{key:\"deselectAll\",value:function deselectAll(items){for(var i=0;i<items.length;i++){if(items[i].selected){items[i].selected=false;}}return items;}},{key:\"addStepAfter\",value:function addStepAfter(itemsState,key,mode,level){var items=_toConsumableArray(itemsState);var itemIndex=items.map(function(item){return item.key;}).indexOf(parseInt(key));// add the new step\nvar mLevel=level;if(level===null){mLevel=items[itemIndex].level;}var descIndexList=this.getDescendents(items,itemIndex);var newItemIndex=descIndexList[descIndexList.length-1]+1;items.splice(newItemIndex,0,{key:this.counter,mode:mode,level:mLevel,selected:true,text:\"\"});this.counter+=1;return[items,newItemIndex];}},{key:\"removeWritingStep\",value:function removeWritingStep(itemsState){var items=_toConsumableArray(itemsState);var newItems=_toConsumableArray(items);for(var i=1;i<items.length;i++){if(items[i].mode===\"writing\"){newItems.splice(i,1);return newItems;}}console.log(\"Didn't find the item, to remove\");return newItems;}},{key:\"removeItem\",value:function removeItem(items,index){items.splice(index,1);return items;}},{key:\"getDescendents\",value:function getDescendents(items,index){var descIndexList=[index];var currentStepLevel=items[index].level;for(var i=index+1;i<items.length;i++){if(items[i].level>currentStepLevel){descIndexList.push(i);}else{break;}}return descIndexList;}},{key:\"updateDescendents\",value:function updateDescendents(items,desIndexList,action){for(var i=1;i<desIndexList.length;i++){if(action===\"level_increase\"){items[desIndexList[i]].level+=1;}else if(action===\"level_decrease\"){items[desIndexList[i]].level-=1;}}return items;}},{key:\"deleteItems\",value:function deleteItems(items,indexList){var newItems=[];items.forEach(function(item,index){if(!indexList.includes(index)){newItems.push(item);}});return newItems;}},{key:\"getPrevSibling\",value:function getPrevSibling(items,index){// pre-condition: index > 0\nfor(var i=index-1;i>0;i--){if(items[i].level<items[index].level){return null;}if(items[index].level===items[i].level){return i;}}return null;}},{key:\"saveUserData\",value:function saveUserData(descriptions,fileName){//const descriptionsJson = JSON.stringify(descriptions);\n}}]);return DescriptionPane;}(React.Component);export{DescriptionPane as default};","map":{"version":3,"sources":["/Users/kian/HAKEE/annotator_app/frontend/src/components/DescriptionPane.jsx"],"names":["React","DragDropContext","Draggable","Droppable","StepDescription","sendDataToServer","DescriptionPane","props","counter","sessionTime","state","descriptions","key","mode","level","selected","text","setModeByKey","bind","getMode","addStepAfter","removeWritingStep","getSelected","getWritingStep","deselectAll","getIndex","getWritingIndex","removeItem","updateDescendents","getDescendents","deleteItems","getPrevSibling","groupDescriptions","getSessionTime","handleSingleClick","handleBlur","handleKeyAction","handleDragEnd","handleWindowResize","descriptionListG","stepComponentsList","map","stepList","index","toString","provided","draggableProps","dragHandleProps","innerRef","item","handleDoubleClick","droppableProps","placeholder","prevProps","videoID","setState","window","addEventListener","removeEventListener","d","Date","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds","stepDescriptionList","i","length","push","result","destination","source","items","sourceStepIndex","destinationStepIndex","steps","destinationOffset","sourceOffset","splice","user","flat","txt","oldWritingIndex","event","which","type","currentStepIndex","descIndexList","prevSiblingIndex","offset","prevStepDescIndexList","currentStepMode","curretnStepIndex","newStepIndex","preventDefault","shiftKey","oldIndex","oldItemIsRemoved","newIndex","stateItems","descriptionKey","itemIndex","indexOf","parseInt","console","log","undefined","itemsState","mLevel","newItemIndex","newItems","currentStepLevel","desIndexList","action","indexList","forEach","includes","fileName","Component"],"mappings":"+vCAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CAGA,MAAO,uBAAP,CACA,OAASC,eAAT,CAA0BC,SAA1B,CAAqCC,SAArC,KAAsD,qBAAtD,CAEA,MAAOC,CAAAA,eAAP,KAA4B,mBAA5B,CACA,OAASC,gBAAT,KAAiC,aAAjC,C,2FAEqBC,CAAAA,e,8HACpB,yBAAYC,KAAZ,CAAmB,iDAClB,uBAAMA,KAAN,EACA,MAAKC,OAAL,CAAe,CAAf,CACA,MAAKC,WAAL,CAAmB,EAAnB,CACA,MAAKC,KAAL,CAAa,CACZC,YAAY,CAAE,CAAC,CAAEC,GAAG,CAAE,CAAP,CAAUC,IAAI,CAAE,SAAhB,CAA2BC,KAAK,CAAE,CAAlC,CAAqCC,QAAQ,CAAE,IAA/C,CAAqDC,IAAI,CAAE,EAA3D,CAAD,CADF,CAAb,CAGA,MAAKR,OAAL,EAAgB,CAAhB,CAEA,MAAKS,YAAL,CAAoB,MAAKA,YAAL,CAAkBC,IAAlB,+BAApB,CACA,MAAKC,OAAL,CAAe,MAAKA,OAAL,CAAaD,IAAb,+BAAf,CACA,MAAKE,YAAL,CAAoB,MAAKA,YAAL,CAAkBF,IAAlB,+BAApB,CACA,MAAKG,iBAAL,CAAyB,MAAKA,iBAAL,CAAuBH,IAAvB,+BAAzB,CACA,MAAKI,WAAL,CAAmB,MAAKA,WAAL,CAAiBJ,IAAjB,+BAAnB,CACA,MAAKK,cAAL,CAAsB,MAAKA,cAAL,CAAoBL,IAApB,+BAAtB,CACA,MAAKM,WAAL,CAAmB,MAAKA,WAAL,CAAiBN,IAAjB,+BAAnB,CACA,MAAKO,QAAL,CAAgB,MAAKA,QAAL,CAAcP,IAAd,+BAAhB,CACA,MAAKQ,eAAL,CAAuB,MAAKA,eAAL,CAAqBR,IAArB,+BAAvB,CACA,MAAKS,UAAL,CAAkB,MAAKA,UAAL,CAAgBT,IAAhB,+BAAlB,CACA,MAAKU,iBAAL,CAAyB,MAAKA,iBAAL,CAAuBV,IAAvB,+BAAzB,CACA,MAAKW,cAAL,CAAsB,MAAKA,cAAL,CAAoBX,IAApB,+BAAtB,CACA,MAAKY,WAAL,CAAmB,MAAKA,WAAL,CAAiBZ,IAAjB,+BAAnB,CACA,MAAKa,cAAL,CAAsB,MAAKA,cAAL,CAAoBb,IAApB,+BAAtB,CACA,MAAKc,iBAAL,CAAyB,MAAKA,iBAAL,CAAuBd,IAAvB,+BAAzB,CACA,MAAKe,cAAL,CAAsB,MAAKA,cAAL,CAAoBf,IAApB,+BAAtB,CAEA,MAAKgB,iBAAL,CAAyB,MAAKA,iBAAL,CAAuBhB,IAAvB,+BAAzB,CACA,MAAKiB,UAAL,CAAkB,MAAKA,UAAL,CAAgBjB,IAAhB,+BAAlB,CACA,MAAKkB,eAAL,CAAuB,MAAKA,eAAL,CAAqBlB,IAArB,+BAAvB,CACA,MAAKmB,aAAL,CAAqB,MAAKA,aAAL,CAAmBnB,IAAnB,+BAArB,CACA,MAAKoB,kBAAL,CAA0B,MAAKA,kBAAL,CAAwBpB,IAAxB,+BAA1B,CA9BkB,aA+BlB,C,kDAED,iBAAS,iBAER,GAAI,KAAKV,OAAL,GAAiB,CAArB,CAAwB,CACvB,KAAKC,WAAL,CAAmB,KAAKwB,cAAL,EAAnB,CACA,CAED,GAAIM,CAAAA,gBAAgB,CAAG,KAAKP,iBAAL,oBAA2B,KAAKtB,KAAL,CAAWC,YAAtC,EAAvB,CAEA,GAAI6B,CAAAA,kBAAkB,CAAGD,gBAAgB,CAACE,GAAjB,CAAqB,SAACC,QAAD,CAAWC,KAAX,qBAC7C,KAAC,SAAD,EAAW,WAAW,CAAEA,KAAK,CAACC,QAAN,EAAxB,CAAiE,KAAK,CAAED,KAAxE,UACE,kBAACE,QAAD,qBAAe,sDAA4B,EAAE,CAAEF,KAAK,CAACC,QAAN,EAAhC,CAAkD,SAAS,CAAC,UAA5D,EAA2EC,QAAQ,CAACC,cAApF,EAAwGD,QAAQ,CAACE,eAAjH,MAAkI,GAAG,CAAEF,QAAQ,CAACG,QAAhJ,UACdN,QAAQ,CAACD,GAAT,CAAa,SAACQ,IAAD,CAAON,KAAP,qBACb,KAAC,eAAD,EACC,EAAE,CAAEM,IAAI,CAACrC,GAAL,CAASgC,QAAT,EADL,CAGC,aAAa,CAAE,MAAI,CAACV,iBAHrB,CAIC,aAAa,CAAE,MAAI,CAACgB,iBAJrB,CAKC,MAAM,CAAE,MAAI,CAACf,UALd,CAMC,UAAU,CAAE,MAAI,CAACC,eANlB,CAOC,IAAI,CAAEa,IAPP,EAEMA,IAAI,CAACrC,GAAL,CAASgC,QAAT,EAFN,CADa,EAAb,CADc,GAAUD,KAAK,CAACC,QAAN,EAAV,CAAf,EADF,EAA+CD,KAAK,CAACC,QAAN,EAA/C,CAD6C,EAArB,CAAzB,CAkBA,mBAAO,KAAC,eAAD,EAAiB,SAAS,CAAE,KAAKP,aAAjC,uBACN,KAAC,SAAD,EAAW,WAAW,CAAC,4BAAvB,UACE,kBAACQ,QAAD,qBAAe,yCAAK,EAAE,CAAC,4BAAR,CAAqC,GAAG,CAAEA,QAAQ,CAACG,QAAnD,EAAiEH,QAAQ,CAACM,cAA1E,gBAA2FX,kBAA3F,CAA+GK,QAAQ,CAACO,WAAxH,IAAf,EADF,EADM,EAAP,CAMA,C,kCAED,4BAAmBC,SAAnB,CAA8B,CAC7B,GAAIA,SAAS,CAACC,OAAV,GAAsB,KAAK/C,KAAL,CAAW+C,OAArC,CAA8C,CAC7C,KAAKC,QAAL,CAAc,CAAC5C,YAAY,CAAE,CAAC,CAAEC,GAAG,CAAE,CAAP,CAAUC,IAAI,CAAE,SAAhB,CAA2BC,KAAK,CAAE,CAAlC,CAAqCC,QAAQ,CAAE,IAA/C,CAAqDC,IAAI,CAAE,EAA3D,CAAD,CAAf,CAAd,EACA,CACD,C,iCAED,4BAAoB,CACnBwC,MAAM,CAACC,gBAAP,CAAwB,QAAxB,CAAkC,KAAKnB,kBAAvC,EACA,C,oCAED,+BAAuB,CACtBkB,MAAM,CAACE,mBAAP,CAA2B,QAA3B,CAAqC,KAAKpB,kBAA1C,EACA,C,kCAED,6BAAqB,CACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA,C,8BAED,yBAAiB,CAChB,GAAIqB,CAAAA,CAAC,CAAG,GAAIC,CAAAA,IAAJ,EAAR,CACA,GAAMnD,CAAAA,WAAW,WAAMkD,CAAC,CAACE,WAAF,EAAN,aAAyBF,CAAC,CAACG,QAAF,GAAe,CAAxC,aAA6CH,CAAC,CAACI,OAAF,EAA7C,aAA4DJ,CAAC,CAACK,QAAF,EAA5D,aAA4EL,CAAC,CAACM,UAAF,EAA5E,aAA8FN,CAAC,CAACO,UAAF,EAA9F,CAAjB,CACA,MAAOzD,CAAAA,WAAP,CACA,C,iCAED,2BAAkBE,YAAlB,CAAgC,CAC/B,GAAI4B,CAAAA,gBAAgB,CAAG,EAAvB,CACA,GAAI4B,CAAAA,mBAAmB,CAAG,EAA1B,CACA,IAAK,GAAIC,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGzD,YAAY,CAAC0D,MAAjC,CAAyCD,CAAC,EAA1C,CAA8C,CAC7C;AACA,GAAIzD,YAAY,CAACyD,CAAD,CAAZ,CAAgBtD,KAAhB,GAA0B,CAA9B,CAAiC,CAChC,GAAIqD,mBAAmB,CAACE,MAAxB,CAAgC,CAC/B9B,gBAAgB,CAAC+B,IAAjB,CAAsBH,mBAAtB,EACA,CACDA,mBAAmB,CAAG,CAACxD,YAAY,CAACyD,CAAD,CAAb,CAAtB,CACA,CALD,IAKO,CACN;AACAD,mBAAmB,CAACG,IAApB,CAAyB3D,YAAY,CAACyD,CAAD,CAArC,EACA,CACD,GAAIA,CAAC,GAAKzD,YAAY,CAAC0D,MAAb,CAAsB,CAAhC,CAAmC,CAClC,GAAIF,mBAAmB,CAACE,MAAxB,CAAgC,CAC/B9B,gBAAgB,CAAC+B,IAAjB,CAAsBH,mBAAtB,EACA,CACD,CACD,CAED,MAAO5B,CAAAA,gBAAP,CACA,C,6BAED,uBAAcgC,MAAd,CAAsB,CACrB,GAAIA,MAAM,CAACC,WAAP,EAAsB,IAA1B,CAAgC,OAChC,GAAID,MAAM,CAACC,WAAP,CAAmB7B,KAAnB,GAA6B4B,MAAM,CAACE,MAAP,CAAc9B,KAA/C,CAAsD,OAEtD,GAAI+B,CAAAA,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAT,CACA;AACA,GAAMgE,CAAAA,eAAe,CAAGJ,MAAM,CAACE,MAAP,CAAc9B,KAAtC,CACA,GAAMiC,CAAAA,oBAAoB,CAAGL,MAAM,CAACC,WAAP,CAAmB7B,KAAhD,CAEA,GAAIkC,CAAAA,KAAK,CAAG,KAAK7C,iBAAL,CAAuB0C,KAAvB,CAAZ,CACA,GAAII,CAAAA,iBAAiB,CAAGF,oBAAoB,CAAGD,eAAvB,CAAyC,CAAzC,CAA6C,CAArE,CACA,GAAII,CAAAA,YAAY,CAAGH,oBAAoB,CAAGD,eAAvB,CAAyC,CAAzC,CAA6C,CAAhE,CAEA;AACAE,KAAK,CAACG,MAAN,CAAaJ,oBAAoB,CAAGE,iBAApC,CAAuD,CAAvD,CAA0DD,KAAK,CAACF,eAAD,CAA/D,EACA;AACAE,KAAK,CAACG,MAAN,CAAaL,eAAe,CAAGI,YAA/B,CAA6C,CAA7C,EACA1E,gBAAgB,CAACqE,KAAD,CAAQ,KAAKjE,WAAb,CAA0B,KAAKF,KAAL,CAAW+C,OAArC,CAA8C,KAAK/C,KAAL,CAAW0E,IAAzD,CAAhB,CACA,KAAK1B,QAAL,CAAc,CAAE5C,YAAY,CAAEkE,KAAK,CAACK,IAAN,EAAhB,CAAd,EACA,C,iCAED,2BAAkBtE,GAAlB,CAAuBuE,GAAvB,CAA4B,CAC3B,GAAIT,CAAAA,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAT,CACA,GAAIwE,GAAG,GAAK,EAAZ,CAAgB,CACf,GAAIxC,CAAAA,KAAK,CAAG,KAAKlB,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAZ,CACA,GAAMwE,CAAAA,eAAe,CAAG,KAAK1D,eAAL,CAAqBgD,KAArB,CAAxB,CACA,GAAIU,eAAe,EAAI,CAAvB,CAA0B,CACzBV,KAAK,CAACU,eAAD,CAAL,CAAuBvE,IAAvB,CAA8B,aAA9B,CACA,CACD6D,KAAK,CAAC/B,KAAD,CAAL,CAAa9B,IAAb,CAAoB,SAApB,CACA6D,KAAK,CAAG,KAAKlD,WAAL,CAAiBkD,KAAjB,CAAR,CACAA,KAAK,CAAC/B,KAAD,CAAL,CAAa5B,QAAb,CAAwB,IAAxB,CACA,KAAKwC,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,C,0BAED,oBAAW9D,GAAX,CAAgBuE,GAAhB,CAAqB,CACpB,GAAIT,CAAAA,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAT,CACA,GAAIwE,GAAG,GAAK,EAAZ,CAAgB,CACf,GAAMxC,CAAAA,KAAK,CAAG,KAAKlB,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAd,CACA8D,KAAK,CAAC/B,KAAD,CAAL,CAAa9B,IAAb,CAAoB,aAApB,CACA6D,KAAK,CAAC/B,KAAD,CAAL,CAAa3B,IAAb,CAAoBmE,GAApB,CACA,CAJD,IAIO,IAAIA,GAAG,GAAK,EAAR,EAAcT,KAAK,CAACL,MAAN,CAAe,CAAjC,CAAoC,CAC1CK,KAAK,CAAG,KAAKrD,iBAAL,CAAuBqD,KAAvB,CAAR,CACA,CACD;AACA,KAAKnB,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,C,+BAED,yBAAgB9D,GAAhB,CAAqBuE,GAArB,CAA0BE,KAA1B,CAAiC,CAChC,GAAIX,CAAAA,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAT,CAEA;AACA,GAAI0E,KAAK,CAACC,KAAN,GAAgB,EAAhB,EAAuBD,KAAK,CAACE,IAAN,GAAe,OAAf,EAA0BJ,GAAG,GAAK,WAA7D,CAA2E,CAC1E,GAAIK,CAAAA,gBAAgB,CAAG,IAAvB,CACA,GAAI5E,GAAG,GAAK,IAAZ,CAAkB,CACjB;AACA4E,gBAAgB,CAAG,KAAKlE,WAAL,CAAiBoD,KAAjB,CAAnB,CACA,CAHD,IAGO,CACN;AACAc,gBAAgB,CAAG,KAAK/D,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAnB,CACA,CAED,GAAI,CAAC8D,KAAK,CAACc,gBAAD,CAAL,CAAwBzE,QAAxB,EAAqCsE,KAAK,CAACE,IAAN,GAAe,OAAf,EAA0BJ,GAAG,GAAK,WAAxE,GAAyFT,KAAK,CAACL,MAAN,EAAgB,CAA7G,CAAgH,CAC/G;AACAK,KAAK,CAAG,KAAKlD,WAAL,CAAiBkD,KAAjB,CAAR,CACA,GAAMe,CAAAA,aAAa,CAAG,KAAK5D,cAAL,CAAoB6C,KAApB,CAA2Bc,gBAA3B,CAAtB,CACA,GAAIA,gBAAgB,GAAK,CAAzB,CAA4B,CAC3Bd,KAAK,CAACc,gBAAgB,CAAGC,aAAa,CAACpB,MAAlC,CAAL,CAA+CtD,QAA/C,CAA0D,IAA1D,CACA,CAFD,IAEO,CACN,GAAM2E,CAAAA,gBAAgB,CAAG,KAAK3D,cAAL,CAAoB2C,KAApB,CAA2Bc,gBAA3B,CAAzB,CACA,GAAIG,CAAAA,MAAM,CAAG,CAAb,CACA,GAAI,EAAED,gBAAgB,EAAI,IAAtB,CAAJ,CAAiC,CAChC,GAAME,CAAAA,qBAAqB,CAAG,KAAK/D,cAAL,CAC7B6C,KAD6B,CAE7BgB,gBAF6B,CAA9B,CAIAC,MAAM,CAAGC,qBAAqB,CAACvB,MAA/B,CACA,CACDK,KAAK,CAACc,gBAAgB,CAAGG,MAApB,CAAL,CAAiC5E,QAAjC,CAA4C,IAA5C,CACA,CACD;AACA,GAAI0E,aAAa,CAACpB,MAAd,CAAuBK,KAAK,CAACL,MAAjC,CAAyC,CACxCK,KAAK,CAAG,KAAK5C,WAAL,CAAiB4C,KAAjB,CAAwBe,aAAxB,CAAR,CACApF,gBAAgB,CAACqE,KAAD,CAAQ,KAAKjE,WAAb,CAA0B,KAAKF,KAAL,CAAW+C,OAArC,CAA8C,KAAK/C,KAAL,CAAW0E,IAAzD,CAAhB,CACA,KAAK1B,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,CACD,CAGD;AAtCA,IAuCK,IAAIW,KAAK,CAACC,KAAN,GAAgB,EAAhB,EAAsBH,GAAG,GAAK,EAAlC,CAAsC,CAC1C,GAAMU,CAAAA,eAAe,CAAG,KAAK1E,OAAL,CAAauD,KAAb,CAAoB9D,GAApB,CAAyB,CAAzB,CAAxB,CACA,GAAMkF,CAAAA,gBAAgB,CAAG,KAAKrE,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAzB,CACA,GAAImF,CAAAA,YAAY,CAAGD,gBAAnB,CACA,GACCD,eAAe,GAAK,SAApB,EACCA,eAAe,GAAK,aAApB,EAAqCnB,KAAK,CAACoB,gBAAD,CAAL,CAAwB/E,QAF/D,CAGE,CACD;AACA2D,KAAK,CAACoB,gBAAD,CAAL,CAAwBjF,IAAxB,CAA+B,aAA/B,CACA6D,KAAK,CAACoB,gBAAD,CAAL,CAAwB9E,IAAxB,CAA+BmE,GAA/B,CACA;AACAT,KAAK,CAAG,KAAKlD,WAAL,CAAiBkD,KAAjB,CAAR,CALC,uBAMuB,KAAKtD,YAAL,CAAkBsD,KAAlB,CAAyB9D,GAAzB,CAA8B,SAA9B,CAAyC,IAAzC,CANvB,8DAMA8D,KANA,wBAMOqB,YANP,wBAODrB,KAAK,CAACqB,YAAD,CAAL,CAAoBhF,QAApB,CAA+B,IAA/B,CACA2D,KAAK,CAACqB,YAAD,CAAL,CAAoBlF,IAApB,CAA2B,SAA3B,CACAR,gBAAgB,CAACqE,KAAD,CAAQ,KAAKjE,WAAb,CAA0B,KAAKF,KAAL,CAAW+C,OAArC,CAA8C,KAAK/C,KAAL,CAAW0E,IAAzD,CAAhB,CACA,KAAK1B,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,CAED;AArBK,IAsBA,IAAIW,KAAK,CAACC,KAAN,GAAgB,CAAhB,EAAqBD,KAAK,CAACE,IAAN,GAAe,OAAxC,CAAiD,CACrDF,KAAK,CAACW,cAAN,GACA;AACA,GAAMR,CAAAA,iBAAgB,CAAG,KAAK/D,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAzB,CAEA,GAAI4E,iBAAgB,CAAG,CAAvB,CAA0B,CACzB,GAAMC,CAAAA,cAAa,CAAG,KAAK5D,cAAL,CAAoB6C,KAApB,CAA2Bc,iBAA3B,CAAtB,CACA;AACA,GAAI,CAACH,KAAK,CAACY,QAAP,EAAmBd,GAAG,GAAK,YAA/B,CAA6C,CAC5C,GAAI,CAACT,KAAK,CAACc,iBAAD,CAAL,CAAwB3E,IAAxB,GAAiC,SAAjC,EAA8CsE,GAAG,GAAK,YAAvD,GAAwET,KAAK,CAACL,MAAN,CAAe,CAA3F,CAA8F,CAC7F,GACCK,KAAK,CAACc,iBAAgB,CAAG,CAApB,CAAL,CAA4B1E,KAA5B,EACA4D,KAAK,CAACc,iBAAD,CAAL,CAAwB1E,KADxB,EAEA4D,KAAK,CAACc,iBAAD,CAAL,CAAwB1E,KAAxB,EAAiC,CAHlC,CAIE,CACD4D,KAAK,CAACc,iBAAD,CAAL,CAAwB1E,KAAxB,EAAiC,CAAjC,CACA4D,KAAK,CAAG,KAAK9C,iBAAL,CACP8C,KADO,CAEPe,cAFO,CAGP,gBAHO,CAAR,CAKApF,gBAAgB,CAACqE,KAAD,CAAQ,KAAKjE,WAAb,CAA0B,KAAKF,KAAL,CAAW+C,OAArC,CAA8C,KAAK/C,KAAL,CAAW0E,IAAzD,CAAhB,CACA,KAAK1B,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,CACD,CAAC,GAAIW,KAAK,CAACY,QAAN,EAAkBd,GAAG,GAAK,aAA9B,CAA6C,CAC9C;AACA,GAAIT,KAAK,CAACc,iBAAD,CAAL,CAAwB1E,KAAxB,EAAiC,CAArC,CAAwC,CACvC4D,KAAK,CAACc,iBAAD,CAAL,CAAwB1E,KAAxB,EAAiC,CAAjC,CACA4D,KAAK,CAAG,KAAK9C,iBAAL,CACP8C,KADO,CAEPe,cAFO,CAGP,gBAHO,CAAR,CAKApF,gBAAgB,CAACqE,KAAD,CAAQ,KAAKjE,WAAb,CAA0B,KAAKF,KAAL,CAAW+C,OAArC,CAA8C,KAAK/C,KAAL,CAAW0E,IAAzD,CAAhB,CACA,KAAK1B,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,CACD,CACD,CAED;AAzCK,IA0CA,IAAIW,KAAK,CAACC,KAAN,GAAgB,EAApB,CAAwB,CAC5BZ,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAL,CACA,GAAMuF,CAAAA,QAAQ,CAAG,KAAKzE,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAjB,CAEA;AACA,GAAIsF,QAAQ,GAAKxB,KAAK,CAACL,MAAN,CAAe,CAAhC,CAAmC,CAClC,KAAKd,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,OACA,CAED;AACA,GAAIS,GAAG,GAAK,EAAZ,CAAgB,CAAE;AACjBT,KAAK,CAACwB,QAAD,CAAL,CAAgBlF,IAAhB,CAAuBmE,GAAvB,CACAT,KAAK,CAACwB,QAAD,CAAL,CAAgBnF,QAAhB,CAA2B,KAA3B,CACA2D,KAAK,CAACwB,QAAD,CAAL,CAAgBrF,IAAhB,CAAuB,aAAvB,CAEA;AACA6D,KAAK,CAACwB,QAAQ,CAAG,CAAZ,CAAL,CAAoBnF,QAApB,CAA+B,IAA/B,CACA2D,KAAK,CAACwB,QAAQ,CAAG,CAAZ,CAAL,CAAoBrF,IAApB,CAA2B,SAA3B,CAEA,CATD,IASO,CAAE;AACR6D,KAAK,CAAG,KAAK/C,UAAL,CAAgB+C,KAAhB,CAAuBwB,QAAvB,CAAR,CAEA;AACAxB,KAAK,CAACwB,QAAD,CAAL,CAAgBnF,QAAhB,CAA2B,IAA3B,CACA2D,KAAK,CAACwB,QAAD,CAAL,CAAgBrF,IAAhB,CAAuB,SAAvB,CACA,CACD,KAAK0C,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CAED;AA9BK,IA+BA,IAAIW,KAAK,CAACC,KAAN,GAAgB,EAApB,CAAwB,CAC5BZ,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAL,CACA,GAAMuF,CAAAA,SAAQ,CAAG,KAAKzE,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAjB,CAEA;AACA,GAAIsF,SAAQ,GAAK,CAAjB,CAAoB,CACnB,KAAK3C,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,OACA,CAED;AACA,GAAIS,GAAG,GAAK,EAAZ,CAAgB,CAAE;AACjBT,KAAK,CAACwB,SAAD,CAAL,CAAgBlF,IAAhB,CAAuBmE,GAAvB,CACAT,KAAK,CAACwB,SAAD,CAAL,CAAgBnF,QAAhB,CAA2B,KAA3B,CACA2D,KAAK,CAACwB,SAAD,CAAL,CAAgBrF,IAAhB,CAAuB,aAAvB,CAEA;AACA6D,KAAK,CAACwB,SAAQ,CAAG,CAAZ,CAAL,CAAoBnF,QAApB,CAA+B,IAA/B,CACA2D,KAAK,CAACwB,SAAQ,CAAG,CAAZ,CAAL,CAAoBrF,IAApB,CAA2B,SAA3B,CAEA,CATD,IASO,CAAE;AACR6D,KAAK,CAAG,KAAK/C,UAAL,CAAgB+C,KAAhB,CAAuBwB,SAAvB,CAAR,CAEA;AACAxB,KAAK,CAACwB,SAAQ,CAAG,CAAZ,CAAL,CAAoBnF,QAApB,CAA+B,IAA/B,CACA2D,KAAK,CAACwB,SAAQ,CAAG,CAAZ,CAAL,CAAoBrF,IAApB,CAA2B,SAA3B,CACA,CACD,KAAK0C,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CA5BI,IA8BA,IAAIW,KAAK,CAACC,KAAN,GAAgB,EAAhB,EAAsBD,KAAK,CAACC,KAAN,GAAgB,EAA1C,CAA8C,CAClDZ,KAAK,oBAAO,KAAKhE,KAAL,CAAWC,YAAlB,CAAL,CACA,GAAMuF,CAAAA,UAAQ,CAAG,KAAKzE,QAAL,CAAciD,KAAd,CAAqB9D,GAArB,CAA0B,CAA1B,CAAjB,CAEA,GAAIsF,UAAQ,GAAKxB,KAAK,CAACL,MAAN,CAAe,CAA5B,EAAiCgB,KAAK,CAACC,KAAN,GAAgB,EAArD,CAAyD,OACzD,GAAIY,UAAQ,GAAK,CAAb,EAAkBb,KAAK,CAACC,KAAN,GAAgB,EAAtC,CAA0C,OAE1C;AACA,GAAIa,CAAAA,gBAAgB,CAAG,KAAvB,CACA,GAAIhB,GAAG,GAAK,EAAZ,CAAgB,CACf,GAAIT,KAAK,CAACL,MAAN,CAAe,CAAnB,CAAsB,CAAE;AACvBK,KAAK,CAAG,KAAK/C,UAAL,CAAgB+C,KAAhB,CAAuBwB,UAAvB,CAAR,CACAC,gBAAgB,CAAG,IAAnB,CACA,CAHD,IAGO,CACN,OAAQ;AACR,CACD,CAPD,IAOO,CACNzB,KAAK,CAACwB,UAAD,CAAL,CAAgBlF,IAAhB,CAAuBmE,GAAvB,CACAT,KAAK,CAACwB,UAAD,CAAL,CAAgBnF,QAAhB,CAA2B,KAA3B,CACA2D,KAAK,CAACwB,UAAD,CAAL,CAAgBrF,IAAhB,CAAuB,aAAvB,CACA,CAED;AACA,GAAIuF,CAAAA,QAAQ,CAAGF,UAAf,CACA,GAAIb,KAAK,CAACC,KAAN,GAAgB,EAApB,CAAwB,CAAG;AAC1B,GAAI,CAACa,gBAAD,EAAqBD,UAAQ,CAAGxB,KAAK,CAACL,MAAN,CAAe,CAAnD,CAAsD,CACrD+B,QAAQ,CAAGF,UAAQ,CAAG,CAAtB,CACA,CACD,CAJD,IAIO,CAAE;AACR,GAAIA,UAAQ,CAAG,CAAf,CACCE,QAAQ,CAAGF,UAAQ,CAAG,CAAtB,CACD,CACDxB,KAAK,CAAG,KAAKlD,WAAL,CAAiBkD,KAAjB,CAAR,CACAA,KAAK,CAAC0B,QAAD,CAAL,CAAgBrF,QAAhB,CAA2B,IAA3B,CACA2D,KAAK,CAAC0B,QAAD,CAAL,CAAgBvF,IAAhB,CAAuB,SAAvB,CACA,KAAK0C,QAAL,CAAc,CAAE5C,YAAY,CAAE+D,KAAhB,CAAd,EACA,CACD,CAED;AACA;AACA;AACA;wBAEA,kBAAS2B,UAAT,CAAqBC,cAArB,CAAqCX,MAArC,CAA6C,CAC5C,GAAIjB,CAAAA,KAAK,oBAAO2B,UAAP,CAAT,CACA,GAAIE,CAAAA,SAAS,CAAG7B,KAAK,CACnBjC,GADc,CACV,SAACQ,IAAD,QAAUA,CAAAA,IAAI,CAACrC,GAAf,EADU,EAEd4F,OAFc,CAENC,QAAQ,CAACH,cAAD,CAFF,CAAhB,CAGA,GAAIC,SAAS,EAAI,CAAjB,CAAoB,CACnB,MAAOA,CAAAA,SAAS,CAAGZ,MAAnB,CACA,CACD,MAAO,CAAC,CAAR,CACA,C,+BAED,yBAAgBjB,KAAhB,CAAuB,CACtB,IAAK,GAAIN,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGM,KAAK,CAACL,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACtC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAASvD,IAAT,GAAkB,SAAtB,CAAiC,CAChC,MAAOuD,CAAAA,CAAP,CACA,CACD,CACD,MAAO,CAAC,CAAR,CACA,C,4BAED,sBAAaiC,UAAb,CAAyBC,cAAzB,CAAyCzF,IAAzC,CAA+C,CAC9C,GAAI6D,CAAAA,KAAK,oBAAO2B,UAAP,CAAT,CACA,GAAIE,CAAAA,SAAS,CAAG7B,KAAK,CACnBjC,GADc,CACV,SAACQ,IAAD,QAAUA,CAAAA,IAAI,CAACrC,GAAf,EADU,EAEd4F,OAFc,CAENC,QAAQ,CAACH,cAAD,CAFF,CAAhB,CAGA,GAAIC,SAAS,EAAI,CAAjB,CAAoB,CACnB7B,KAAK,CAAC6B,SAAD,CAAL,CAAiB1F,IAAjB,CAAwBA,IAAxB,CACA,CAFD,IAEO,CACN6F,OAAO,CAACC,GAAR,CAAY,iCAAZ,EACA,CAED,MAAOjC,CAAAA,KAAP,CACA,C,uBAED,iBAAQ2B,UAAR,CAAoBC,cAApB,CAAoCX,MAApC,CAA4C,CAC3C,GAAIjB,CAAAA,KAAK,oBAAO2B,UAAP,CAAT,CACA,GAAIE,CAAAA,SAAS,CAAG7B,KAAK,CACnBjC,GADc,CACV,SAACQ,IAAD,QAAUA,CAAAA,IAAI,CAACrC,GAAf,EADU,EAEd4F,OAFc,CAENC,QAAQ,CAACH,cAAD,CAFF,CAAhB,CAGA,GAAI5B,KAAK,CAAC6B,SAAS,CAAGZ,MAAb,CAAL,GAA8BiB,SAAlC,CAA6C,CAC5C,MAAOlC,CAAAA,KAAK,CAAC6B,SAAS,CAAGZ,MAAb,CAAL,CAA0B9E,IAAjC,CACA,CACD,MAAO+F,CAAAA,SAAP,CACA,C,2BAED,qBAAYlC,KAAZ,CAAmB,CAClB,IAAK,GAAIN,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGM,KAAK,CAACL,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACtC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAASrD,QAAb,CAAuB,CACtB,MAAOqD,CAAAA,CAAP,CACA,CACD,CACD,MAAO,CAAC,CAAR,CACA,C,8BAED,wBAAeM,KAAf,CAAsB,CACrB,IAAK,GAAIN,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGM,KAAK,CAACL,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACtC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAASvD,IAAT,GAAkB,SAAtB,CAAiC,CAChC,MAAOuD,CAAAA,CAAP,CACA,CACD,CACD,MAAO,CAAC,CAAR,CACA,C,2BAED,qBAAYM,KAAZ,CAAmB,CAClB,IAAK,GAAIN,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGM,KAAK,CAACL,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACtC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAASrD,QAAb,CAAuB,CACtB2D,KAAK,CAACN,CAAD,CAAL,CAASrD,QAAT,CAAoB,KAApB,CACA,CACD,CACD,MAAO2D,CAAAA,KAAP,CACA,C,4BAED,sBAAamC,UAAb,CAAyBjG,GAAzB,CAA8BC,IAA9B,CAAoCC,KAApC,CAA2C,CAC1C,GAAI4D,CAAAA,KAAK,oBAAOmC,UAAP,CAAT,CACA,GAAIN,CAAAA,SAAS,CAAG7B,KAAK,CAACjC,GAAN,CAAU,SAACQ,IAAD,QAAUA,CAAAA,IAAI,CAACrC,GAAf,EAAV,EAA8B4F,OAA9B,CAAsCC,QAAQ,CAAC7F,GAAD,CAA9C,CAAhB,CACA;AACA,GAAIkG,CAAAA,MAAM,CAAGhG,KAAb,CACA,GAAIA,KAAK,GAAK,IAAd,CAAoB,CACnBgG,MAAM,CAAGpC,KAAK,CAAC6B,SAAD,CAAL,CAAiBzF,KAA1B,CACA,CACD,GAAM2E,CAAAA,aAAa,CAAG,KAAK5D,cAAL,CAAoB6C,KAApB,CAA2B6B,SAA3B,CAAtB,CACA,GAAIQ,CAAAA,YAAY,CAAGtB,aAAa,CAACA,aAAa,CAACpB,MAAd,CAAuB,CAAxB,CAAb,CAA0C,CAA7D,CACAK,KAAK,CAACM,MAAN,CAAa+B,YAAb,CAA2B,CAA3B,CAA8B,CAC7BnG,GAAG,CAAE,KAAKJ,OADmB,CAE7BK,IAAI,CAAEA,IAFuB,CAG7BC,KAAK,CAAEgG,MAHsB,CAI7B/F,QAAQ,CAAE,IAJmB,CAK7BC,IAAI,CAAE,EALuB,CAA9B,EAOA,KAAKR,OAAL,EAAgB,CAAhB,CAEA,MAAO,CAACkE,KAAD,CAAQqC,YAAR,CAAP,CACA,C,iCAED,2BAAkBF,UAAlB,CAA8B,CAC7B,GAAInC,CAAAA,KAAK,oBAAOmC,UAAP,CAAT,CACA,GAAIG,CAAAA,QAAQ,oBAAOtC,KAAP,CAAZ,CACA,IAAK,GAAIN,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGM,KAAK,CAACL,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACtC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAASvD,IAAT,GAAkB,SAAtB,CAAiC,CAChCmG,QAAQ,CAAChC,MAAT,CAAgBZ,CAAhB,CAAmB,CAAnB,EACA,MAAO4C,CAAAA,QAAP,CACA,CACD,CACDN,OAAO,CAACC,GAAR,CAAY,iCAAZ,EACA,MAAOK,CAAAA,QAAP,CACA,C,0BAED,oBAAWtC,KAAX,CAAkB/B,KAAlB,CAAyB,CACxB+B,KAAK,CAACM,MAAN,CAAarC,KAAb,CAAoB,CAApB,EACA,MAAO+B,CAAAA,KAAP,CACA,C,8BAED,wBAAeA,KAAf,CAAsB/B,KAAtB,CAA6B,CAC5B,GAAI8C,CAAAA,aAAa,CAAG,CAAC9C,KAAD,CAApB,CACA,GAAMsE,CAAAA,gBAAgB,CAAGvC,KAAK,CAAC/B,KAAD,CAAL,CAAa7B,KAAtC,CACA,IAAK,GAAIsD,CAAAA,CAAC,CAAGzB,KAAK,CAAG,CAArB,CAAwByB,CAAC,CAAGM,KAAK,CAACL,MAAlC,CAA0CD,CAAC,EAA3C,CAA+C,CAC9C,GAAIM,KAAK,CAACN,CAAD,CAAL,CAAStD,KAAT,CAAiBmG,gBAArB,CAAuC,CACtCxB,aAAa,CAACnB,IAAd,CAAmBF,CAAnB,EACA,CAFD,IAEO,CACN,MACA,CACD,CACD,MAAOqB,CAAAA,aAAP,CACA,C,iCAED,2BAAkBf,KAAlB,CAAyBwC,YAAzB,CAAuCC,MAAvC,CAA+C,CAC9C,IAAK,GAAI/C,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAG8C,YAAY,CAAC7C,MAAjC,CAAyCD,CAAC,EAA1C,CAA8C,CAC7C,GAAI+C,MAAM,GAAK,gBAAf,CAAiC,CAChCzC,KAAK,CAACwC,YAAY,CAAC9C,CAAD,CAAb,CAAL,CAAuBtD,KAAvB,EAAgC,CAAhC,CACA,CAFD,IAEO,IAAIqG,MAAM,GAAK,gBAAf,CAAiC,CACvCzC,KAAK,CAACwC,YAAY,CAAC9C,CAAD,CAAb,CAAL,CAAuBtD,KAAvB,EAAgC,CAAhC,CACA,CACD,CAED,MAAO4D,CAAAA,KAAP,CACA,C,2BAED,qBAAYA,KAAZ,CAAmB0C,SAAnB,CAA8B,CAC7B,GAAIJ,CAAAA,QAAQ,CAAG,EAAf,CACAtC,KAAK,CAAC2C,OAAN,CAAc,SAACpE,IAAD,CAAON,KAAP,CAAiB,CAC9B,GAAI,CAACyE,SAAS,CAACE,QAAV,CAAmB3E,KAAnB,CAAL,CAAgC,CAC/BqE,QAAQ,CAAC1C,IAAT,CAAcrB,IAAd,EACA,CACD,CAJD,EAKA,MAAO+D,CAAAA,QAAP,CACA,C,8BAED,wBAAetC,KAAf,CAAsB/B,KAAtB,CAA6B,CAC5B;AACA,IAAK,GAAIyB,CAAAA,CAAC,CAAGzB,KAAK,CAAG,CAArB,CAAwByB,CAAC,CAAG,CAA5B,CAA+BA,CAAC,EAAhC,CAAoC,CACnC,GAAIM,KAAK,CAACN,CAAD,CAAL,CAAStD,KAAT,CAAiB4D,KAAK,CAAC/B,KAAD,CAAL,CAAa7B,KAAlC,CAAyC,CACxC,MAAO,KAAP,CACA,CACD,GAAI4D,KAAK,CAAC/B,KAAD,CAAL,CAAa7B,KAAb,GAAuB4D,KAAK,CAACN,CAAD,CAAL,CAAStD,KAApC,CAA2C,CAC1C,MAAOsD,CAAAA,CAAP,CACA,CACD,CACD,MAAO,KAAP,CACA,C,4BAED,sBAAazD,YAAb,CAA2B4G,QAA3B,CAAqC,CACpC;AACA,C,6BAtiB2CvH,KAAK,CAACwH,S,SAA9BlH,e","sourcesContent":["import React from \"react\";\n\n\nimport \"./DescriptionPane.css\";\nimport { DragDropContext, Draggable, Droppable } from \"react-beautiful-dnd\";\n\nimport StepDescription from \"./StepDescription\";\nimport { sendDataToServer } from \"../apiCalls\"\n\nexport default class DescriptionPane extends React.Component {\n\tconstructor(props) {\n\t\tsuper(props);\n\t\tthis.counter = 0;\n\t\tthis.sessionTime = \"\"\n\t\tthis.state = {\n\t\t\tdescriptions: [{ key: 0, mode: \"writing\", level: 1, selected: true, text: \"\" }],\n\t\t};\n\t\tthis.counter += 1;\n\n\t\tthis.setModeByKey = this.setModeByKey.bind(this);\n\t\tthis.getMode = this.getMode.bind(this);\n\t\tthis.addStepAfter = this.addStepAfter.bind(this);\n\t\tthis.removeWritingStep = this.removeWritingStep.bind(this);\n\t\tthis.getSelected = this.getSelected.bind(this);\n\t\tthis.getWritingStep = this.getWritingStep.bind(this);\n\t\tthis.deselectAll = this.deselectAll.bind(this);\n\t\tthis.getIndex = this.getIndex.bind(this);\n\t\tthis.getWritingIndex = this.getWritingIndex.bind(this);\n\t\tthis.removeItem = this.removeItem.bind(this);\n\t\tthis.updateDescendents = this.updateDescendents.bind(this);\n\t\tthis.getDescendents = this.getDescendents.bind(this);\n\t\tthis.deleteItems = this.deleteItems.bind(this);\n\t\tthis.getPrevSibling = this.getPrevSibling.bind(this);\n\t\tthis.groupDescriptions = this.groupDescriptions.bind(this);\n\t\tthis.getSessionTime = this.getSessionTime.bind(this);\n\n\t\tthis.handleSingleClick = this.handleSingleClick.bind(this);\n\t\tthis.handleBlur = this.handleBlur.bind(this);\n\t\tthis.handleKeyAction = this.handleKeyAction.bind(this);\n\t\tthis.handleDragEnd = this.handleDragEnd.bind(this);\n\t\tthis.handleWindowResize = this.handleWindowResize.bind(this);\n\t}\n\n\trender() {\n\n\t\tif (this.counter === 2) {\n\t\t\tthis.sessionTime = this.getSessionTime();\n\t\t}\n\n\t\tlet descriptionListG = this.groupDescriptions([...this.state.descriptions]);\n\n\t\tlet stepComponentsList = descriptionListG.map((stepList, index) => (\n\t\t\t<Draggable draggableId={index.toString()} key={index.toString()} index={index}>\n\t\t\t\t{(provided) => (<div key={index.toString()} id={index.toString()} className=\"step-div\" {...provided.draggableProps} {...provided.dragHandleProps} ref={provided.innerRef}>\n\t\t\t\t\t{stepList.map((item, index) => (\n\t\t\t\t\t\t<StepDescription\n\t\t\t\t\t\t\tid={item.key.toString()}\n\t\t\t\t\t\t\tkey={item.key.toString()}\n\t\t\t\t\t\t\tonSingleClick={this.handleSingleClick}\n\t\t\t\t\t\t\tonDoubleClick={this.handleDoubleClick}\n\t\t\t\t\t\t\tonBlur={this.handleBlur}\n\t\t\t\t\t\t\tonKeyPress={this.handleKeyAction}\n\t\t\t\t\t\t\titem={item}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))}\n\t\t\t\t</div>)}\n\t\t\t</Draggable>\n\t\t));\n\n\t\treturn <DragDropContext onDragEnd={this.handleDragEnd}>\n\t\t\t<Droppable droppableId=\"description-pane-droppable\" >\n\t\t\t\t{(provided) => (<div id=\"description-pane-container\" ref={provided.innerRef} {...provided.droppableProps}>{stepComponentsList}{provided.placeholder}</div>)}\n\t\t\t</Droppable>\n\t\t</DragDropContext>\n\n\t}\n\n\tcomponentDidUpdate(prevProps) {\n\t\tif (prevProps.videoID !== this.props.videoID) {\n\t\t\tthis.setState({descriptions: [{ key: 0, mode: \"writing\", level: 1, selected: true, text: \"\" }]});\n\t\t}\n\t}\n\n\tcomponentDidMount() {\n\t\twindow.addEventListener(\"resize\", this.handleWindowResize)\n\t}\n\n\tcomponentWillUnmount() {\n\t\twindow.removeEventListener(\"resize\", this.handleWindowResize)\n\t}\n\n\thandleWindowResize() {\n\t\t// const windowWidth = window.innerWidth;\n\t\t// const windowHeight = window.innerHeight;\n\t\t// if (windowWidth < 1600) {\n\t\t//     let paneContainer = document.getElementById(\"description-pane-container\");\n\t\t// \tpaneContainer.style.width = 490;\n\t\t// } else {\n\t\t// \tlet paneContainer = document.getElementById(\"description-pane-container\");\n\t\t// \tpaneContainer.style.width = 550;\n\t\t// }\n\n\t\t// console.log(\"width: \", windowWidth);\n\t\t// console.log(\"height: \", windowHeight);\n\t}\n\n\tgetSessionTime() {\n\t\tlet d = new Date();\n\t\tconst sessionTime = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}-${d.getHours()}-${d.getMinutes()}-${d.getSeconds()}`;\n\t\treturn sessionTime;\n\t}\n\n\tgroupDescriptions(descriptions) {\n\t\tlet descriptionListG = [];\n\t\tlet stepDescriptionList = [];\n\t\tfor (let i = 0; i < descriptions.length; i++) {\n\t\t\t// new step\n\t\t\tif (descriptions[i].level === 1) {\n\t\t\t\tif (stepDescriptionList.length) {\n\t\t\t\t\tdescriptionListG.push(stepDescriptionList);\n\t\t\t\t}\n\t\t\t\tstepDescriptionList = [descriptions[i]];\n\t\t\t} else {\n\t\t\t\t// descendents\n\t\t\t\tstepDescriptionList.push(descriptions[i]);\n\t\t\t}\n\t\t\tif (i === descriptions.length - 1) {\n\t\t\t\tif (stepDescriptionList.length) {\n\t\t\t\t\tdescriptionListG.push(stepDescriptionList);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn descriptionListG;\n\t}\n\n\thandleDragEnd(result) {\n\t\tif (result.destination == null) return;\n\t\tif (result.destination.index === result.source.index) return;\n\n\t\tlet items = [...this.state.descriptions];\n\t\t// step-set level index\n\t\tconst sourceStepIndex = result.source.index;\n\t\tconst destinationStepIndex = result.destination.index;\n\n\t\tlet steps = this.groupDescriptions(items);\n\t\tlet destinationOffset = destinationStepIndex > sourceStepIndex ? 1 : 0;\n\t\tlet sourceOffset = destinationStepIndex > sourceStepIndex ? 0 : 1;\n\n\t\t// move a copy of source step into the new location\n\t\tsteps.splice(destinationStepIndex + destinationOffset, 0, steps[sourceStepIndex]);\n\t\t// remove the old copy of source step\n\t\tsteps.splice(sourceStepIndex + sourceOffset, 1);\n\t\tsendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\tthis.setState({ descriptions: steps.flat() });\n\t}\n\n\thandleSingleClick(key, txt) {\n\t\tlet items = [...this.state.descriptions];\n\t\tif (txt !== \"\") {\n\t\t\tlet index = this.getIndex(items, key, 0);\n\t\t\tconst oldWritingIndex = this.getWritingIndex(items);\n\t\t\tif (oldWritingIndex >= 0) {\n\t\t\t\titems[oldWritingIndex].mode = \"not_writing\";\n\t\t\t}\n\t\t\titems[index].mode = \"writing\";\n\t\t\titems = this.deselectAll(items);\n\t\t\titems[index].selected = true;\n\t\t\tthis.setState({ descriptions: items });\n\t\t}\n\t}\n\n\thandleBlur(key, txt) {\n\t\tlet items = [...this.state.descriptions];\n\t\tif (txt !== \"\") {\n\t\t\tconst index = this.getIndex(items, key, 0);\n\t\t\titems[index].mode = \"not_writing\";\n\t\t\titems[index].text = txt;\n\t\t} else if (txt === \"\" && items.length > 1) {\n\t\t\titems = this.removeWritingStep(items);\n\t\t}\n\t\t//sendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\tthis.setState({ descriptions: items });\n\t}\n\n\thandleKeyAction(key, txt, event) {\n\t\tlet items = [...this.state.descriptions];\n\n\t\t// del --> delete step\n\t\tif (event.which === 46 || (event.type === 'click' && txt === 'close_btn')) {\n\t\t\tlet currentStepIndex = null;\n\t\t\tif (key === null) {\n\t\t\t\t// delete (window listener)\n\t\t\t\tcurrentStepIndex = this.getSelected(items);\n\t\t\t} else {\n\t\t\t\t// delete (<input> listener)\n\t\t\t\tcurrentStepIndex = this.getIndex(items, key, 0);\n\t\t\t}\n\n\t\t\tif ((items[currentStepIndex].selected || (event.type === 'click' && txt === 'close_btn')) && items.length >= 2) {\n\t\t\t\t// select the previous/next step\n\t\t\t\titems = this.deselectAll(items);\n\t\t\t\tconst descIndexList = this.getDescendents(items, currentStepIndex);\n\t\t\t\tif (currentStepIndex === 0) {\n\t\t\t\t\titems[currentStepIndex + descIndexList.length].selected = true;\n\t\t\t\t} else {\n\t\t\t\t\tconst prevSiblingIndex = this.getPrevSibling(items, currentStepIndex);\n\t\t\t\t\tlet offset = 1;\n\t\t\t\t\tif (!(prevSiblingIndex == null)) {\n\t\t\t\t\t\tconst prevStepDescIndexList = this.getDescendents(\n\t\t\t\t\t\t\titems,\n\t\t\t\t\t\t\tprevSiblingIndex\n\t\t\t\t\t\t);\n\t\t\t\t\t\toffset = prevStepDescIndexList.length;\n\t\t\t\t\t}\n\t\t\t\t\titems[currentStepIndex - offset].selected = true;\n\t\t\t\t}\n\t\t\t\t// do not delete everything\n\t\t\t\tif (descIndexList.length < items.length) {\n\t\t\t\t\titems = this.deleteItems(items, descIndexList);\n\t\t\t\t\tsendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\t// Enter --> nex step (writing)\n\t\telse if (event.which === 13 && txt !== \"\") {\n\t\t\tconst currentStepMode = this.getMode(items, key, 0);\n\t\t\tconst curretnStepIndex = this.getIndex(items, key, 0);\n\t\t\tlet newStepIndex = curretnStepIndex;\n\t\t\tif (\n\t\t\t\tcurrentStepMode === \"writing\" ||\n\t\t\t\t(currentStepMode === \"not_writing\" && items[curretnStepIndex].selected)\n\t\t\t) {\n\t\t\t\t// change the current step to non-writing and add one writing step after it\n\t\t\t\titems[curretnStepIndex].mode = \"not_writing\";\n\t\t\t\titems[curretnStepIndex].text = txt;\n\t\t\t\t// select the current step\n\t\t\t\titems = this.deselectAll(items);\n\t\t\t\t[items, newStepIndex] = this.addStepAfter(items, key, \"writing\", null);\n\t\t\t\titems[newStepIndex].selected = true;\n\t\t\t\titems[newStepIndex].mode = \"writing\";\n\t\t\t\tsendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t}\n\t\t}\n\n\t\t// Tab or Shift + Tab\n\t\telse if (event.which === 9 || event.type === \"click\") {\n\t\t\tevent.preventDefault();\n\t\t\t// perform indention if it is writing\n\t\t\tconst currentStepIndex = this.getIndex(items, key, 0);\n\n\t\t\tif (currentStepIndex > 0) {\n\t\t\t\tconst descIndexList = this.getDescendents(items, currentStepIndex);\n\t\t\t\t// only tab\n\t\t\t\tif (!event.shiftKey || txt === \"indent_btn\") {\n\t\t\t\t\tif ((items[currentStepIndex].mode === \"writing\" || txt === \"indent_btn\") && items.length > 1) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\titems[currentStepIndex - 1].level >=\n\t\t\t\t\t\t\titems[currentStepIndex].level &&\n\t\t\t\t\t\t\titems[currentStepIndex].level <= 2\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\titems[currentStepIndex].level += 1;\n\t\t\t\t\t\t\titems = this.updateDescendents(\n\t\t\t\t\t\t\t\titems,\n\t\t\t\t\t\t\t\tdescIndexList,\n\t\t\t\t\t\t\t\t\"level_increase\"\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tsendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\t\t\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} if (event.shiftKey || txt === \"outdent_btn\") {\n\t\t\t\t\t// shift + tab\n\t\t\t\t\tif (items[currentStepIndex].level >= 2) {\n\t\t\t\t\t\titems[currentStepIndex].level -= 1;\n\t\t\t\t\t\titems = this.updateDescendents(\n\t\t\t\t\t\t\titems,\n\t\t\t\t\t\t\tdescIndexList,\n\t\t\t\t\t\t\t\"level_decrease\"\n\t\t\t\t\t\t);\n\t\t\t\t\t\tsendDataToServer(items, this.sessionTime, this.props.videoID, this.props.user);\n\t\t\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// down\n\t\telse if (event.which === 40) {\n\t\t\titems = [...this.state.descriptions];\n\t\t\tconst oldIndex = this.getIndex(items, key, 0);\n\n\t\t\t// can't go down\n\t\t\tif (oldIndex === items.length - 1) {\n\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// update the selected item\n\t\t\tif (txt !== \"\") { // keep the old item\n\t\t\t\titems[oldIndex].text = txt;\n\t\t\t\titems[oldIndex].selected = false;\n\t\t\t\titems[oldIndex].mode = \"not_writing\";\n\n\t\t\t\t// select the new item\n\t\t\t\titems[oldIndex + 1].selected = true;\n\t\t\t\titems[oldIndex + 1].mode = \"writing\";\n\n\t\t\t} else { // must be removed\n\t\t\t\titems = this.removeItem(items, oldIndex);\n\n\t\t\t\t// select the new item\n\t\t\t\titems[oldIndex].selected = true;\n\t\t\t\titems[oldIndex].mode = \"writing\";\n\t\t\t}\n\t\t\tthis.setState({ descriptions: items });\n\t\t}\n\n\t\t// up\n\t\telse if (event.which === 38) {\n\t\t\titems = [...this.state.descriptions];\n\t\t\tconst oldIndex = this.getIndex(items, key, 0);\n\n\t\t\t// can't go up\n\t\t\tif (oldIndex === 0) {\n\t\t\t\tthis.setState({ descriptions: items });\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// update the selected item\n\t\t\tif (txt !== \"\") { // keep the old item\n\t\t\t\titems[oldIndex].text = txt;\n\t\t\t\titems[oldIndex].selected = false;\n\t\t\t\titems[oldIndex].mode = \"not_writing\";\n\n\t\t\t\t// select the new item\n\t\t\t\titems[oldIndex - 1].selected = true;\n\t\t\t\titems[oldIndex - 1].mode = \"writing\";\n\n\t\t\t} else { // must be removed\n\t\t\t\titems = this.removeItem(items, oldIndex);\n\n\t\t\t\t// select the new item\n\t\t\t\titems[oldIndex - 1].selected = true;\n\t\t\t\titems[oldIndex - 1].mode = \"writing\";\n\t\t\t}\n\t\t\tthis.setState({ descriptions: items });\n\t\t}\n\n\t\telse if (event.which === 40 || event.which === 38) {\n\t\t\titems = [...this.state.descriptions];\n\t\t\tconst oldIndex = this.getIndex(items, key, 0);\n\n\t\t\tif (oldIndex === items.length - 1 && event.which === 40) return;\n\t\t\tif (oldIndex === 0 && event.which === 38) return;\n\n\t\t\t// take care of the old selected item\n\t\t\tlet oldItemIsRemoved = false;\n\t\t\tif (txt === \"\") {\n\t\t\t\tif (items.length > 1) { // should be  deleted\n\t\t\t\t\titems = this.removeItem(items, oldIndex);\n\t\t\t\t\toldItemIsRemoved = true;\n\t\t\t\t} else {\n\t\t\t\t\treturn; // length = 0 --> you cannot go to another item\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\titems[oldIndex].text = txt;\n\t\t\t\titems[oldIndex].selected = false;\n\t\t\t\titems[oldIndex].mode = \"not_writing\";\n\t\t\t}\n\n\t\t\t// selected the new item (already know that items.length > 1)\n\t\t\tlet newIndex = oldIndex;\n\t\t\tif (event.which === 40) {  // down\n\t\t\t\tif (!oldItemIsRemoved && oldIndex < items.length - 1) {\n\t\t\t\t\tnewIndex = oldIndex + 1;\n\t\t\t\t}\n\t\t\t} else { // up\n\t\t\t\tif (oldIndex > 0)\n\t\t\t\t\tnewIndex = oldIndex - 1;\n\t\t\t}\n\t\t\titems = this.deselectAll(items);\n\t\t\titems[newIndex].selected = true;\n\t\t\titems[newIndex].mode = \"writing\";\n\t\t\tthis.setState({ descriptions: items });\n\t\t}\n\t}\n\n\t// TODO:\n\t// 4) add guiddance (key bindings, ...)\n\t// 5) record timestamp\n\t// 6) record video control events (number of times, and types (jump to the future/past))\n\n\tgetIndex(stateItems, descriptionKey, offset) {\n\t\tlet items = [...stateItems];\n\t\tlet itemIndex = items\n\t\t\t.map((item) => item.key)\n\t\t\t.indexOf(parseInt(descriptionKey));\n\t\tif (itemIndex >= 0) {\n\t\t\treturn itemIndex + offset;\n\t\t}\n\t\treturn -1;\n\t}\n\n\tgetWritingIndex(items) {\n\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\tif (items[i].mode === \"writing\") {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn -1;\n\t}\n\n\tsetModeByKey(stateItems, descriptionKey, mode) {\n\t\tlet items = [...stateItems];\n\t\tlet itemIndex = items\n\t\t\t.map((item) => item.key)\n\t\t\t.indexOf(parseInt(descriptionKey));\n\t\tif (itemIndex >= 0) {\n\t\t\titems[itemIndex].mode = mode;\n\t\t} else {\n\t\t\tconsole.log(\"step description does not exist\");\n\t\t}\n\n\t\treturn items;\n\t}\n\n\tgetMode(stateItems, descriptionKey, offset) {\n\t\tlet items = [...stateItems];\n\t\tlet itemIndex = items\n\t\t\t.map((item) => item.key)\n\t\t\t.indexOf(parseInt(descriptionKey));\n\t\tif (items[itemIndex + offset] !== undefined) {\n\t\t\treturn items[itemIndex + offset].mode;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tgetSelected(items) {\n\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\tif (items[i].selected) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn -1;\n\t}\n\n\tgetWritingStep(items) {\n\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\tif (items[i].mode === \"writing\") {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn -1;\n\t}\n\n\tdeselectAll(items) {\n\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\tif (items[i].selected) {\n\t\t\t\titems[i].selected = false;\n\t\t\t}\n\t\t}\n\t\treturn items;\n\t}\n\n\taddStepAfter(itemsState, key, mode, level) {\n\t\tlet items = [...itemsState];\n\t\tlet itemIndex = items.map((item) => item.key).indexOf(parseInt(key));\n\t\t// add the new step\n\t\tlet mLevel = level;\n\t\tif (level === null) {\n\t\t\tmLevel = items[itemIndex].level;\n\t\t}\n\t\tconst descIndexList = this.getDescendents(items, itemIndex);\n\t\tlet newItemIndex = descIndexList[descIndexList.length - 1] + 1;\n\t\titems.splice(newItemIndex, 0, {\n\t\t\tkey: this.counter,\n\t\t\tmode: mode,\n\t\t\tlevel: mLevel,\n\t\t\tselected: true,\n\t\t\ttext: \"\"\n\t\t});\n\t\tthis.counter += 1;\n\n\t\treturn [items, newItemIndex];\n\t}\n\n\tremoveWritingStep(itemsState) {\n\t\tlet items = [...itemsState];\n\t\tlet newItems = [...items];\n\t\tfor (let i = 1; i < items.length; i++) {\n\t\t\tif (items[i].mode === \"writing\") {\n\t\t\t\tnewItems.splice(i, 1);\n\t\t\t\treturn newItems;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\"Didn't find the item, to remove\");\n\t\treturn newItems;\n\t}\n\n\tremoveItem(items, index) {\n\t\titems.splice(index, 1);\n\t\treturn items;\n\t}\n\n\tgetDescendents(items, index) {\n\t\tlet descIndexList = [index];\n\t\tconst currentStepLevel = items[index].level;\n\t\tfor (let i = index + 1; i < items.length; i++) {\n\t\t\tif (items[i].level > currentStepLevel) {\n\t\t\t\tdescIndexList.push(i);\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn descIndexList;\n\t}\n\n\tupdateDescendents(items, desIndexList, action) {\n\t\tfor (let i = 1; i < desIndexList.length; i++) {\n\t\t\tif (action === \"level_increase\") {\n\t\t\t\titems[desIndexList[i]].level += 1;\n\t\t\t} else if (action === \"level_decrease\") {\n\t\t\t\titems[desIndexList[i]].level -= 1;\n\t\t\t}\n\t\t}\n\n\t\treturn items;\n\t}\n\n\tdeleteItems(items, indexList) {\n\t\tlet newItems = [];\n\t\titems.forEach((item, index) => {\n\t\t\tif (!indexList.includes(index)) {\n\t\t\t\tnewItems.push(item);\n\t\t\t}\n\t\t});\n\t\treturn newItems;\n\t}\n\n\tgetPrevSibling(items, index) {\n\t\t// pre-condition: index > 0\n\t\tfor (let i = index - 1; i > 0; i--) {\n\t\t\tif (items[i].level < items[index].level) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tif (items[index].level === items[i].level) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tsaveUserData(descriptions, fileName) {\n\t\t//const descriptionsJson = JSON.stringify(descriptions);\n\t}\n}\n"]},"metadata":{},"sourceType":"module"}